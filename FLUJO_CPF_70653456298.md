# Flujo de Scraping para CPF: 70653456298

Este documento explica el flujo completo de scraping de recomendaciones para tu CPF.

## üìã Requisitos Previos

Antes de empezar, aseg√∫rate de tener:

1. ‚úÖ Node.js y npm instalados
2. ‚úÖ Redis corriendo (puerto 6379)
3. ‚úÖ Dependencias instaladas: `npm install`
4. ‚úÖ Playwright instalado: `npx playwright install chromium`
5. ‚úÖ Servidor iniciado: `npm run start:dev`

## üöÄ Opci√≥n 1: Usando el Script de Test (M√°s F√°cil)

```bash
cd examples
./test-cpf-70653456298.sh
```

Este script hace todo autom√°ticamente:
- Inicia el job de scraping
- Espera a que complete
- Muestra los resultados

**Salida esperada:**
```
‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó
‚ïë  Test de Recomendaciones por CPF - Emarsys Scarab           ‚ïë
‚ïë  CPF: 70653456298                                            ‚ïë
‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù

üöÄ 1. Iniciando solicitud de recomendaciones...

‚úÖ Respuesta del servidor:
{
  "id": "123",
  "status": "pending",
  "startedAt": "2024-01-20T10:00:00.000Z"
}

üìã Job ID: 123

‚è≥ 2. Esperando a que el job complete...

   [Intento 1/60] Status: pending
   [Intento 2/60] Status: processing
   [Intento 3/60] Status: processing
   [Intento 4/60] Status: completed

üéâ ¬°Job completado exitosamente!

üìä RESULTADOS DEL SCRAPING
===========================================================================
Total de productos: 10
Duraci√≥n: 15000ms
Fecha: 2024-01-20T10:00:15.000Z

üõçÔ∏è PRODUCTOS RECOMENDADOS PARA CPF: 70653456298
===========================================================================

üì¶ Producto: Smartphone Galaxy S23
   ID: prod-456
   Precio: 2999.99 BRL
   Categor√≠a: Eletr√¥nicos>Smartphones
   Marca: Samsung
   URL: https://loja.com/produto/456

... m√°s productos ...
```

## üîß Opci√≥n 2: Paso a Paso con cURL

### Paso 1: Iniciar el Job

```bash
curl -X POST http://localhost:3000/api/scraping/recommendations/cpf \
  -H "Content-Type: application/json" \
  -d '{
    "cpf": "70653456298",
    "recommendLogic": "PERSONAL",
    "limit": 10,
    "headless": true
  }'
```

**Respuesta:**
```json
{
  "id": "123",
  "status": "pending",
  "startedAt": "2024-01-20T10:00:00.000Z"
}
```

üëâ **Guarda el `id` del job** (en este caso: `123`)

### Paso 2: Consultar el Estado

```bash
# Reemplaza 123 con tu Job ID
curl http://localhost:3000/api/scraping/jobs/123
```

**Mientras est√° procesando:**
```json
{
  "id": "123",
  "status": "processing",
  "startedAt": "2024-01-20T10:00:00.000Z"
}
```

**Cuando termine (15-30 segundos despu√©s):**
```json
{
  "id": "123",
  "status": "completed",
  "startedAt": "2024-01-20T10:00:00.000Z",
  "completedAt": "2024-01-20T10:00:15.000Z",
  "result": {
    "success": true,
    "products": [...],
    "totalProducts": 10,
    "duration": 15000
  }
}
```

### Paso 3: Ver Resultados Formateados

```bash
# Usa jq para ver los productos de forma bonita
curl -s http://localhost:3000/api/scraping/jobs/123 | jq '.result.products'
```

## üíª Opci√≥n 3: Usando TypeScript

```bash
cd examples
npx ts-node test-my-cpf.ts
```

## üéØ Diferentes Tipos de Recomendaciones

Puedes probar diferentes l√≥gicas cambiando el par√°metro `recommendLogic`:

### PERSONAL - Recomendaciones Personalizadas
```bash
curl -X POST http://localhost:3000/api/scraping/recommendations/cpf \
  -H "Content-Type: application/json" \
  -d '{
    "cpf": "70653456298",
    "recommendLogic": "PERSONAL",
    "limit": 10
  }'
```
üëâ Productos basados en tu historial de compras y navegaci√≥n

### RELATED - Productos Relacionados
```bash
curl -X POST http://localhost:3000/api/scraping/recommendations/cpf \
  -H "Content-Type: application/json" \
  -d '{
    "cpf": "70653456298",
    "recommendLogic": "RELATED",
    "limit": 10
  }'
```
üëâ Productos similares a los que has visto

### POPULAR - M√°s Populares
```bash
curl -X POST http://localhost:3000/api/scraping/recommendations/cpf \
  -H "Content-Type: application/json" \
  -d '{
    "cpf": "70653456298",
    "recommendLogic": "POPULAR",
    "limit": 10
  }'
```
üëâ Productos m√°s vendidos

### ALSO_BOUGHT - Comprados Juntos
```bash
curl -X POST http://localhost:3000/api/scraping/recommendations/cpf \
  -H "Content-Type: application/json" \
  -d '{
    "cpf": "70653456298",
    "recommendLogic": "ALSO_BOUGHT",
    "limit": 10
  }'
```
üëâ Productos que otros compraron junto con los tuyos

## üîç Filtros Avanzados

### Filtrar por Categor√≠a
```bash
curl -X POST http://localhost:3000/api/scraping/recommendations/cpf \
  -H "Content-Type: application/json" \
  -d '{
    "cpf": "70653456298",
    "recommendLogic": "PERSONAL",
    "includeCategories": ["Eletr√¥nicos>Smartphones", "Inform√°tica>Notebooks"],
    "limit": 10
  }'
```

### Excluir Productos Espec√≠ficos
```bash
curl -X POST http://localhost:3000/api/scraping/recommendations/cpf \
  -H "Content-Type: application/json" \
  -d '{
    "cpf": "70653456298",
    "recommendLogic": "PERSONAL",
    "excludeItems": ["prod-123", "prod-456"],
    "limit": 10
  }'
```

### Combinaci√≥n de Filtros
```bash
curl -X POST http://localhost:3000/api/scraping/recommendations/cpf \
  -H "Content-Type: application/json" \
  -d '{
    "cpf": "70653456298",
    "recommendLogic": "PERSONAL",
    "includeCategories": ["Eletr√¥nicos"],
    "excludeItems": ["prod-old-123"],
    "limit": 20,
    "timeout": 45000
  }'
```

## üìä Monitorear el Sistema

### Ver Todos los Jobs
```bash
curl http://localhost:3000/api/scraping/jobs
```

### Ver Estad√≠sticas
```bash
curl http://localhost:3000/api/scraping/stats
```

**Respuesta:**
```json
{
  "waiting": 2,
  "active": 1,
  "completed": 15,
  "failed": 0,
  "delayed": 0,
  "total": 18
}
```

### Limpiar Jobs Viejos
```bash
curl -X DELETE http://localhost:3000/api/scraping/jobs/completed/clear
```

## ‚öôÔ∏è Configuraci√≥n Opcional

Si necesitas configurar credenciales espec√≠ficas, edita el archivo `.env`:

```env
# Tu configuraci√≥n
EMARSYS_URL=https://extend.emarsys.com
EMARSYS_SCARAB_ID=TU_SCARAB_ID_AQUI
EMARSYS_USERNAME=tu_usuario@example.com
EMARSYS_PASSWORD=tu_password
```

## üêõ Troubleshooting

### Error: "Connection refused"
```bash
# Verificar que el servidor est√© corriendo
curl http://localhost:3000/api/stats

# Si no responde, iniciar el servidor:
npm run start:dev
```

### Error: "Redis connection failed"
```bash
# Verificar que Redis est√© corriendo
redis-cli ping
# Debe responder: PONG

# Si no est√° corriendo:
docker run -d -p 6379:6379 redis:7-alpine
```

### Job se queda en "pending"
```bash
# Ver los logs del servidor
# Verificar que no haya errores

# Reintentar el job:
curl -X POST http://localhost:3000/api/scraping/jobs/123/retry
```

### No se encuentran productos
Posibles razones:
1. El CPF no existe en el sistema de Emarsys
2. No hay suficiente historial para generar recomendaciones
3. Prueba con otra l√≥gica: `POPULAR` en lugar de `PERSONAL`

## üì± Usando Postman o Insomnia

1. Importa el archivo: `examples/cpf-api-requests.http`
2. Cambia la variable `@cpf` a `70653456298`
3. Ejecuta el request "Obtener recomendaciones por CPF"

## üéì Pr√≥ximos Pasos

1. ‚úÖ Probar diferentes l√≥gicas de recomendaci√≥n
2. ‚úÖ Experimentar con filtros de categor√≠a
3. ‚úÖ Integrar los resultados en tu aplicaci√≥n
4. ‚úÖ Configurar cach√© para mejor rendimiento
5. ‚úÖ Monitorear el sistema con las estad√≠sticas

## üìö Recursos Adicionales

- [Gu√≠a Completa de CPF](CPF_GUIDE.md)
- [README Principal](README.md)
- [Documentaci√≥n Swagger](http://localhost:3000/api/docs)
- [Ejemplos de C√≥digo](examples/)

---

**¬øNecesitas ayuda?** Revisa los logs del servidor o consulta la documentaci√≥n completa.
