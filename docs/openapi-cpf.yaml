openapi: 3.0.3
info:
  title: Emarsys CPF Recommendations API
  description: |
    # üéØ API de Recomenda√ß√µes de Produtos por CPF

    Esta API permite obter recomenda√ß√µes personalizadas de produtos usando **Emarsys Scarab**
    baseadas no CPF do cliente.

    ## üìã Caracter√≠sticas

    - ‚úÖ Recomenda√ß√µes personalizadas por CPF
    - ‚úÖ M√∫ltiplas l√≥gicas de recomenda√ß√£o (PERSONAL, RELATED, POPULAR, etc.)
    - ‚úÖ Filtros por categoria e exclus√£o de produtos
    - ‚úÖ Sistema de cache inteligente
    - ‚úÖ Jobs ass√≠ncronos com rastreamento de status
    - ‚úÖ Reintentos autom√°ticos

    ## üöÄ Como Usar

    1. **Criar Job**: POST `/api/scraping/recommendations/cpf` com seu CPF
    2. **Aguardar**: O job processa em 15-30 segundos
    3. **Consultar**: GET `/api/scraping/jobs/{id}` para obter resultados

    ## üîë L√≥gicas de Recomenda√ß√£o

    | L√≥gica | Descri√ß√£o | Caso de Uso |
    |--------|-----------|-------------|
    | **PERSONAL** | Baseado no hist√≥rico do usu√°rio | Homepage, emails personalizados |
    | **RELATED** | Produtos relacionados | P√°gina de produto |
    | **ALSO_BOUGHT** | Comprados juntos | Carrinho, checkout |
    | **POPULAR** | Mais vendidos | Homepage, categorias |
    | **CATEGORY** | Mesma categoria | Navega√ß√£o por categoria |
    | **CART** | Baseado no carrinho | P√°gina de carrinho |

    ## üìû Contato & Suporte

    Para mais informa√ß√µes, consulte a [documenta√ß√£o completa](https://github.com/seu-repo).

  version: 1.0.0
  contact:
    name: API Support
    email: support@example.com
  license:
    name: MIT
    url: https://opensource.org/licenses/MIT

servers:
  - url: http://localhost:3000
    description: Servidor de Desenvolvimento
  - url: https://api.production.com
    description: Servidor de Produ√ß√£o

tags:
  - name: CPF Recommendations
    description: Endpoint para obter recomenda√ß√µes de produtos por CPF
  - name: Job Status
    description: Endpoints para gerenciar e consultar jobs

paths:
  /api/scraping/recommendations/cpf:
    post:
      tags:
        - CPF Recommendations
      summary: Obter recomenda√ß√µes de produtos por CPF
      description: |
        Cria um job ass√≠ncrono para obter recomenda√ß√µes personalizadas de produtos
        usando Emarsys Scarab baseado no CPF do cliente.

        ### üìù Como Funciona

        1. Voc√™ envia uma requisi√ß√£o com o CPF
        2. O sistema cria um job e retorna um ID
        3. O job processa em background (15-30 segundos)
        4. Voc√™ consulta o status usando o ID do job
        5. Quando completo, os produtos est√£o no resultado

        ### ‚ö° Exemplo R√°pido

        ```bash
        # 1. Criar job (com autentica√ß√£o)
        curl -X POST http://localhost:3000/api/scraping/recommendations/cpf \
          -H "Content-Type: application/json" \
          -H "X-API-Key: sua-api-key" \
          -d '{"cpf":"12345678900","recommendLogic":"PERSONAL","limit":10}'

        # Resposta: {"id":"123","status":"pending"}

        # 2. Consultar resultado (ap√≥s 15-30s)
        curl -H "X-API-Key: sua-api-key" \
          http://localhost:3000/api/scraping/jobs/123
        ```

        ### üî• Dicas

        - Use `PERSONAL` para recomenda√ß√µes baseadas no hist√≥rico
        - Configure `useCache: true` para melhor performance
        - Limite entre 5-20 produtos para melhor UX

      operationId: getRecommendationsByCpf
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/CpfRecommendationRequest'
            examples:
              basic:
                summary: Requisi√ß√£o B√°sica
                value:
                  cpf: "12345678900"
                  recommendLogic: "PERSONAL"
                  limit: 10
              withFilters:
                summary: Com Filtros de Categoria
                value:
                  cpf: "123.456.789-00"
                  recommendLogic: "PERSONAL"
                  limit: 15
                  includeCategories:
                    - "Eletr√¥nicos>Smartphones"
                    - "Inform√°tica>Notebooks"
              withExclusions:
                summary: Com Exclus√µes
                value:
                  cpf: "12345678900"
                  recommendLogic: "RELATED"
                  limit: 10
                  excludeItems:
                    - "prod-123"
                    - "prod-456"
              popular:
                summary: Produtos Populares
                value:
                  cpf: "70653456298"
                  recommendLogic: "POPULAR"
                  limit: 20
      responses:
        '202':
          description: |
            Job criado com sucesso. O processamento est√° em andamento.
            Use o `id` retornado para consultar o status.
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/JobCreated'
              example:
                id: "123"
                status: "pending"
                startedAt: "2024-01-20T10:00:00.000Z"
        '400':
          description: Requisi√ß√£o inv√°lida (CPF inv√°lido, par√¢metros incorretos)
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
              example:
                statusCode: 400
                message: "CPF deve estar em formato 123.456.789-00 ou 12345678900"
                error: "Bad Request"
        '401':
          description: N√£o autorizado - API Key inv√°lida ou ausente
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
              examples:
                missing:
                  summary: API Key ausente
                  value:
                    statusCode: 401
                    message: "API Key is missing"
                    error: "Unauthorized"
                invalid:
                  summary: API Key inv√°lida
                  value:
                    statusCode: 401
                    message: "Invalid API Key"
                    error: "Unauthorized"
        '500':
          description: Erro interno do servidor
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

  /api/scraping/jobs/{id}:
    get:
      tags:
        - Job Status
      summary: Consultar status de um job
      description: |
        Obt√©m o status e resultado de um job de recomenda√ß√µes.

        ### üìä Status Poss√≠veis

        - **pending**: Job criado, aguardando processamento
        - **processing**: Job em execu√ß√£o
        - **completed**: Job conclu√≠do com sucesso
        - **failed**: Job falhou (veja campo `error`)

        ### ‚è±Ô∏è Tempo de Processamento

        Normalmente: 15-30 segundos

        ### üí° Polling

        Consulte a cada 2-3 segundos at√© status = "completed"

      operationId: getJobStatus
      parameters:
        - name: id
          in: path
          required: true
          description: ID do job retornado ao criar a requisi√ß√£o
          schema:
            type: string
          example: "123"
      responses:
        '200':
          description: Status do job obtido com sucesso
          content:
            application/json:
              schema:
                oneOf:
                  - $ref: '#/components/schemas/JobPending'
                  - $ref: '#/components/schemas/JobProcessing'
                  - $ref: '#/components/schemas/JobCompleted'
                  - $ref: '#/components/schemas/JobFailed'
              examples:
                pending:
                  summary: Job Pendente
                  value:
                    id: "123"
                    status: "pending"
                    startedAt: "2024-01-20T10:00:00.000Z"
                processing:
                  summary: Job Processando
                  value:
                    id: "123"
                    status: "processing"
                    startedAt: "2024-01-20T10:00:00.000Z"
                completed:
                  summary: Job Completo
                  value:
                    id: "123"
                    status: "completed"
                    startedAt: "2024-01-20T10:00:00.000Z"
                    completedAt: "2024-01-20T10:00:15.000Z"
                    result:
                      success: true
                      products:
                        - id: "prod-456"
                          name: "Smartphone Galaxy S23"
                          price: 2999.99
                          currency: "BRL"
                          category: "Eletr√¥nicos>Smartphones"
                          brand: "Samsung"
                          imageUrl: "https://example.com/image.jpg"
                          url: "https://loja.com/produto/456"
                      totalProducts: 10
                      scrapedAt: "2024-01-20T10:00:15.000Z"
                      duration: 15000
        '401':
          description: N√£o autorizado - API Key inv√°lida ou ausente
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
              example:
                statusCode: 401
                message: "API Key is missing"
                error: "Unauthorized"
        '404':
          description: Job n√£o encontrado
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
              example:
                statusCode: 404
                message: "Job 123 not found"

  /api/scraping/stats:
    get:
      tags:
        - Job Status
      summary: Obter estat√≠sticas da fila de jobs
      description: |
        Retorna estat√≠sticas sobre os jobs na fila.

        √ötil para monitoramento e debugging.

        üîì **Este endpoint √© p√∫blico** - n√£o requer autentica√ß√£o.
      operationId: getStats
      security: []
      responses:
        '200':
          description: Estat√≠sticas obtidas com sucesso
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/QueueStats'
              example:
                waiting: 2
                active: 1
                completed: 45
                failed: 3
                delayed: 0
                total: 51

components:
  schemas:
    CpfRecommendationRequest:
      type: object
      required:
        - cpf
      properties:
        cpf:
          type: string
          description: |
            CPF do cliente (com ou sem formata√ß√£o)

            **Formatos aceitos:**
            - `123.456.789-00` (com pontos e h√≠fen)
            - `12345678900` (apenas n√∫meros)
          pattern: '^\d{3}\.\d{3}\.\d{3}-\d{2}$|^\d{11}$'
          example: "12345678900"
        scarabId:
          type: string
          description: |
            ID do Scarab (merchant ID do Emarsys)

            Se n√£o fornecido, usa o configurado em `.env`
          example: "1916F613C8B45191"
        recommendLogic:
          type: string
          description: |
            L√≥gica de recomenda√ß√£o a ser usada

            **Op√ß√µes dispon√≠veis:**
            - `PERSONAL`: Recomenda√ß√µes personalizadas baseadas no hist√≥rico
            - `RELATED`: Produtos relacionados
            - `ALSO_BOUGHT`: Produtos comprados juntos
            - `POPULAR`: Produtos mais populares
            - `CATEGORY`: Produtos da mesma categoria
            - `CART`: Baseado no carrinho atual
          enum:
            - PERSONAL
            - RELATED
            - ALSO_BOUGHT
            - POPULAR
            - CATEGORY
            - CART
          default: "PERSONAL"
          example: "PERSONAL"
        limit:
          type: integer
          description: N√∫mero m√°ximo de produtos a recomendar
          minimum: 1
          maximum: 100
          default: 10
          example: 10
        includeCategories:
          type: array
          description: |
            Lista de categorias para incluir nas recomenda√ß√µes

            **Formato:** Use `>` para separar n√≠veis

            **Exemplo:** `["Eletr√¥nicos>Smartphones", "Moda>Feminino>Vestidos"]`
          items:
            type: string
          example:
            - "Eletr√¥nicos>Smartphones"
            - "Inform√°tica>Notebooks"
        excludeItems:
          type: array
          description: |
            IDs de produtos a serem exclu√≠dos das recomenda√ß√µes

            √ötil para n√£o recomendar produtos j√° comprados ou visualizados
          items:
            type: string
          example:
            - "prod-123"
            - "prod-456"
        timeout:
          type: integer
          description: Timeout em milissegundos
          minimum: 5000
          maximum: 300000
          default: 30000
          example: 30000
        headless:
          type: boolean
          description: Se deve usar modo headless (sem interface gr√°fica)
          default: true
          example: true
        useCache:
          type: boolean
          description: |
            Se deve usar cache

            Resultados s√£o cacheados por 1 hora baseado em: CPF + l√≥gica + limite
          default: true
          example: true

    JobCreated:
      type: object
      properties:
        id:
          type: string
          description: ID √∫nico do job
          example: "123"
        status:
          type: string
          enum: [pending]
          example: "pending"
        startedAt:
          type: string
          format: date-time
          example: "2024-01-20T10:00:00.000Z"

    JobPending:
      type: object
      properties:
        id:
          type: string
          example: "123"
        status:
          type: string
          enum: [pending]
          example: "pending"
        startedAt:
          type: string
          format: date-time
          example: "2024-01-20T10:00:00.000Z"

    JobProcessing:
      type: object
      properties:
        id:
          type: string
          example: "123"
        status:
          type: string
          enum: [processing]
          example: "processing"
        startedAt:
          type: string
          format: date-time
          example: "2024-01-20T10:00:00.000Z"

    JobCompleted:
      type: object
      properties:
        id:
          type: string
          example: "123"
        status:
          type: string
          enum: [completed]
          example: "completed"
        startedAt:
          type: string
          format: date-time
          example: "2024-01-20T10:00:00.000Z"
        completedAt:
          type: string
          format: date-time
          example: "2024-01-20T10:00:15.000Z"
        result:
          $ref: '#/components/schemas/ScrapingResult'

    JobFailed:
      type: object
      properties:
        id:
          type: string
          example: "123"
        status:
          type: string
          enum: [failed]
          example: "failed"
        startedAt:
          type: string
          format: date-time
          example: "2024-01-20T10:00:00.000Z"
        completedAt:
          type: string
          format: date-time
          example: "2024-01-20T10:00:15.000Z"
        error:
          type: string
          example: "Scarab script not found"

    ScrapingResult:
      type: object
      properties:
        success:
          type: boolean
          example: true
        products:
          type: array
          items:
            $ref: '#/components/schemas/Product'
        totalProducts:
          type: integer
          example: 10
        scrapedAt:
          type: string
          format: date-time
          example: "2024-01-20T10:00:15.000Z"
        duration:
          type: integer
          description: Dura√ß√£o em milissegundos
          example: 15000
        error:
          type: string
          description: Mensagem de erro (se houver)

    Product:
      type: object
      properties:
        id:
          type: string
          description: ID √∫nico do produto
          example: "prod-456"
        name:
          type: string
          description: Nome do produto
          example: "Smartphone Galaxy S23"
        description:
          type: string
          description: Descri√ß√£o do produto
          example: "128GB, Preto, 5G"
        price:
          type: number
          description: Pre√ßo do produto
          example: 2999.99
        currency:
          type: string
          description: Moeda do pre√ßo
          example: "BRL"
        imageUrl:
          type: string
          format: uri
          description: URL da imagem do produto
          example: "https://example.com/images/prod-456.jpg"
        url:
          type: string
          format: uri
          description: URL da p√°gina do produto
          example: "https://loja.com/produto/456"
        category:
          type: string
          description: Categoria do produto
          example: "Eletr√¥nicos>Smartphones"
        brand:
          type: string
          description: Marca do produto
          example: "Samsung"
        sku:
          type: string
          description: SKU do produto
          example: "SM-S911B"
        inStock:
          type: boolean
          description: Se est√° em estoque
          example: true
        rating:
          type: number
          description: Avalia√ß√£o do produto
          minimum: 0
          maximum: 5
          example: 4.5
        reviewCount:
          type: integer
          description: N√∫mero de avalia√ß√µes
          example: 1234
        scrapedAt:
          type: string
          format: date-time
          description: Data/hora do scraping
          example: "2024-01-20T10:00:15.000Z"

    QueueStats:
      type: object
      properties:
        waiting:
          type: integer
          description: Jobs aguardando processamento
          example: 2
        active:
          type: integer
          description: Jobs sendo processados
          example: 1
        completed:
          type: integer
          description: Jobs completados
          example: 45
        failed:
          type: integer
          description: Jobs que falharam
          example: 3
        delayed:
          type: integer
          description: Jobs atrasados
          example: 0
        total:
          type: integer
          description: Total de jobs
          example: 51

    Error:
      type: object
      properties:
        statusCode:
          type: integer
          example: 400
        message:
          type: string
          example: "Validation failed"
        error:
          type: string
          example: "Bad Request"

  securitySchemes:
    ApiKeyHeader:
      type: apiKey
      in: header
      name: X-API-Key
      description: |
        API Key enviada no header `X-API-Key`

        Exemplo: `X-API-Key: sua-api-key-aqui`
    BearerAuth:
      type: http
      scheme: bearer
      description: |
        API Key enviada como Bearer token

        Exemplo: `Authorization: Bearer sua-api-key-aqui`
    ApiKeyQuery:
      type: apiKey
      in: query
      name: api_key
      description: |
        API Key enviada como query parameter

        Exemplo: `?api_key=sua-api-key-aqui`

        ‚ö†Ô∏è N√£o recomendado para produ√ß√£o

security:
  - ApiKeyHeader: []
  - BearerAuth: []
  - ApiKeyQuery: []

x-tagGroups:
  - name: Recomenda√ß√µes
    tags:
      - CPF Recommendations
  - name: Gerenciamento
    tags:
      - Job Status
